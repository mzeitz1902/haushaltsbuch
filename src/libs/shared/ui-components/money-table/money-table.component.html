<mat-card>
  <mat-card-content>
    <cdk-accordion-item #accItem="cdkAccordionItem">
      @if (headerTitle()) {
        <header
          class="sticky top-14 z-10 grid w-full grid-cols-[2rem_10rem_auto_1rem] items-center gap-2 overflow-hidden bg-gray-800 py-2 backdrop-blur transition-all duration-100 md:top-16"
          (click)="accItem.toggle()"
        >
          <app-icon [icon]="headerIcon()" size="medium" />
          <div #col2 class="flex items-center gap-2">
            <h2 class="w-min text-sm font-semibold text-gray-100">
              {{ headerTitle() }}
            </h2>
            @if (isSaving()) {
              <mat-spinner diameter="18" />
            }
            <h1
              class="text-(length:--text-xs) leading-(--text-sm--line-height) font-medium"
            >
              {{ total() | currency: 'EUR' }}
            </h1>
          </div>
          <div class="w-5">
            @if (accItem.expanded) {
              <button
                class="w-5"
                maffiButton
                icon="CirclePlus"
                size="small"
                (click)="addRow.emit(); $event.stopPropagation()"
                animate.enter="animate-fade-in"
                animate.leave="animate-fade-out"
              >
                Hinzuf√ºgen
              </button>
            }
          </div>

          <app-icon
            [icon]="accItem.expanded ? 'ChevronDown' : 'ChevronDown'"
            size="small"
            class="ml-1"
          />
        </header>
      }

      <div
        class="overflow-hidden transition-[max-height] duration-300 ease-in-out"
        [style.max-height]="accItem.expanded ? '1000px' : '0px'"
      >
        @if (isLoading()) {
          <mat-spinner class="self-center" />
        } @else {
          <div
            class="flex w-full items-center justify-center rounded-lg bg-gray-800 p-1"
            animate.enter="animate-fade-in"
          >
            <table
              mat-table
              [dataSource]="data()"
              [trackBy]="trackByFn"
              class="mt-2 !min-w-[95%] !bg-transparent !p-4"
            >
              <ng-container matColumnDef="category">
                <td
                  mat-cell
                  *matCellDef="let row"
                  class="!h-1 !w-24 !p-0.5 !text-xs !text-gray-100"
                >
                  @if (
                    selectedRow() === row.id && selectedField() === 'category'
                  ) {
                    <input
                      #category
                      class="w-24 rounded border-1 border-blue-400 bg-gray-600 p-1 outline-none"
                      [field]="form.category"
                      (blur)="submitAndReset()"
                      (keyup.enter)="onCategoryEnterPressed()"
                    />
                  } @else {
                    <div
                      class="flex h-5 w-full items-center gap-1"
                      (click)="editCategory(row)"
                    >
                      <span>
                        {{ row.category }}
                      </span>
                      @if (row.remark) {
                        <app-icon
                          class="z-1"
                          icon="Info"
                          [matTooltip]="row.remark"
                          matTooltipPosition="after"
                        />
                      }
                    </div>
                  }
                </td>
                <td
                  mat-footer-cell
                  *matFooterCellDef
                  class="!h-1 !p-0 !pt-2 font-semibold !text-gray-100"
                >
                  Summe
                </td>
              </ng-container>

              <ng-container matColumnDef="value">
                <td
                  mat-cell
                  *matCellDef="let row"
                  class="!h-1 !w-12 !p-0 !text-right !text-xs !text-gray-100"
                >
                  @if (
                    selectedRow() === row.id && selectedField() === 'value'
                  ) {
                    <input
                      type="number"
                      #value
                      class="w-12 rounded border-1 border-blue-400 bg-gray-600 p-1 text-right outline-none"
                      [field]="form.value"
                      (blur)="submitAndReset()"
                      (keyup.enter)="selectedRow.set(null)"
                    />
                  } @else {
                    <span class="block h-5 w-full" (click)="editValue(row)">
                      {{ row.value | currency: 'EUR' }}
                    </span>
                  }
                </td>
                <td
                  mat-footer-cell
                  *matFooterCellDef
                  class="!p-0 !pt-2 !text-right font-semibold !text-gray-100"
                >
                  {{ total() | currency: 'EUR' }}
                </td>
              </ng-container>

              <ng-container matColumnDef="delete_button">
                <td
                  mat-cell
                  *matCellDef="let row"
                  class="self-right w-1 !p-0 !text-right"
                >
                  <button
                    maffiButton
                    class="mb-1"
                    icon="Trash"
                    size="mini"
                    theme="secondary"
                    (click)="deleteRow.emit(row.id)"
                  ></button>
                </td>
                <td mat-footer-cell *matFooterCellDef></td>
              </ng-container>

              @for (col of customColumns(); track $index) {
                <ng-container [matColumnDef]="col.name">
                  <td
                    mat-cell
                    *matCellDef="let row"
                    class="!overflow-visible !p-0 !text-xs !text-gray-100"
                  >
                    <ng-template
                      [ngTemplateOutlet]="col.template"
                      [ngTemplateOutletContext]="{ $implicit: row }"
                    />
                  </td>
                  <td mat-footer-cell *matFooterCellDef></td>
                </ng-container>
              }

              <tr
                mat-row
                *matRowDef="let row; columns: displayedColumns()"
                class="!h-1"
              ></tr>
              <tr
                mat-footer-row
                *matFooterRowDef="displayedColumns()"
                class="!h-1"
              ></tr>
            </table>
          </div>
        }
      </div>
    </cdk-accordion-item>
  </mat-card-content>
</mat-card>
