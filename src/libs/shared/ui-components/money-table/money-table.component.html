<mat-card class="!bg-gray-800 !py-2 transition-all duration-100">
  <mat-card-content class="!p-2">
    <cdk-accordion-item #accItem="cdkAccordionItem">
      @if (headerTitle() || showAddButton()) {
        <header
          class="sticky top-14 z-10 flex h-5 items-center justify-between bg-gray-800 px-3 py-2 backdrop-blur transition-all duration-100 md:top-16"
          (click)="accItem.toggle()"
        >
          <div class="grid w-full grid-cols-[127px_1fr] items-center gap-4">
            <div class="flex items-center gap-1">
              @if (headerIcon()) {
                <i-lucide [name]="headerIcon()" />
              }
              <h2 class="text-sm font-semibold text-gray-100">
                {{ headerTitle() }}
              </h2>
            </div>

            <div class="flex items-center">
              @if (isLoading()) {
                <mat-spinner diameter="18" />
              }
              <h1
                class="text-(length:--text-xs) leading-(--text-sm--line-height) font-medium"
              >
                {{ total() | safeNumber }}€
              </h1>
              <i-lucide
                [name]="accItem.expanded ? 'chevron-up' : 'chevron-down'"
              />
            </div>

            @if (isSaving()) {
              <mat-spinner class="self-center" diameter="18" />
            }
          </div>
          @if (showAddButton() && accItem.expanded) {
            <button
              maffiButton
              icon="CirclePlus"
              size="small"
              (click)="addRow.emit(); $event.stopPropagation()"
              animate.enter="animate-fade-in"
              animate.leave="animate-fade-out"
            >
              Hinzufügen
            </button>
          }
        </header>
      }

      <div
        class="overflow-hidden transition-[max-height] duration-300 ease-in-out"
        [style.max-height]="accItem.expanded ? '1000px' : '0px'"
      >
        @if (isLoading()) {
          <mat-spinner class="self-center" />
        } @else {
          <div
            class="flex w-full items-center justify-center rounded-lg bg-gray-800 p-1"
            animate.enter="animate-fade-in"
          >
            <table
              mat-table
              [dataSource]="data()"
              [trackBy]="trackByFn"
              [formGroup]="form"
              class="mt-2 !min-w-[95%] !bg-transparent !p-4"
            >
              <ng-container matColumnDef="category">
                <td
                  mat-cell
                  *matCellDef="let row"
                  class="!h-1 !w-24 !p-0.5 !text-xs !text-gray-100"
                >
                  @if (
                    selectedRow() === row.id && selectedField() === 'category'
                  ) {
                    <input
                      #category
                      class="w-24 rounded border-1 border-blue-400 bg-gray-600 p-1 outline-none"
                      formControlName="category"
                      (blur)="resetForm()"
                      (keyup.enter)="onCategoryEnterPressed()"
                    />
                  } @else {
                    <span class="block h-5 w-full" (click)="editCategory(row)">
                      {{ row.category }}
                    </span>
                  }
                </td>
                <td
                  mat-footer-cell
                  *matFooterCellDef
                  class="!h-1 !p-0 !pt-2 font-semibold !text-gray-100"
                >
                  Summe
                </td>
              </ng-container>

              <ng-container matColumnDef="value">
                <td
                  mat-cell
                  *matCellDef="let row"
                  class="!h-1 !w-12 !p-0 !text-right !text-xs !text-gray-100"
                >
                  @if (
                    selectedRow() === row.id && selectedField() === 'value'
                  ) {
                    <input
                      #value
                      class="w-12 rounded border-1 border-blue-400 bg-gray-600 p-1 text-right outline-none"
                      formControlName="value"
                      (blur)="resetForm()"
                      (keyup.enter)="selectedRow.set(null)"
                    />
                  } @else {
                    <span class="block h-5 w-full" (click)="editValue(row)">
                      {{ row.value | safeNumber }}
                    </span>
                  }
                </td>
                <td
                  mat-footer-cell
                  *matFooterCellDef
                  class="!p-0 !pt-2 !text-right font-semibold !text-gray-100"
                >
                  {{ total() | safeNumber }}
                </td>
              </ng-container>

              <ng-container matColumnDef="delete_button">
                <td
                  mat-cell
                  *matCellDef="let row"
                  class="self-right w-1 !p-0 !text-right"
                >
                  <button
                    maffiButton
                    icon="Trash"
                    size="mini"
                    theme="secondary"
                    (click)="deleteRow.emit(row.id)"
                  ></button>
                </td>
                <td mat-footer-cell *matFooterCellDef></td>
              </ng-container>

              @for (col of customColumns(); track $index) {
                <ng-container [matColumnDef]="col.name">
                  <td
                    mat-cell
                    *matCellDef="let row"
                    class="!overflow-visible !p-0 !text-xs !text-gray-100"
                  >
                    <ng-template
                      [ngTemplateOutlet]="col.template"
                      [ngTemplateOutletContext]="{ $implicit: row }"
                    />
                  </td>
                  <td mat-footer-cell *matFooterCellDef></td>
                </ng-container>
              }

              <tr
                mat-row
                *matRowDef="let row; columns: displayedColumns()"
                class="!h-1"
              ></tr>
              <tr
                mat-footer-row
                *matFooterRowDef="displayedColumns()"
                class="!h-1"
              ></tr>
            </table>
          </div>
        }
      </div>
    </cdk-accordion-item>
  </mat-card-content>
</mat-card>
