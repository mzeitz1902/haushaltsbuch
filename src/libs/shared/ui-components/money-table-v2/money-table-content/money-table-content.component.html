<main>
  @if (isExpanded()) {
    <section
      class="flex w-full flex-col gap-3 rounded-lg bg-gray-800 p-1"
      animate.enter="animate-fade-in"
    >
      <header class="empty:hidden">
        @if (useDataTemplate() === 'valuesWithHistory') {
          <div class="grid grid-cols-[43%_20%_18%_1fr] items-center gap-2">
            <div></div>
            <span class="text-right text-sm">Forecast</span>
            <span class="text-right text-sm">Wert</span>
            <div></div>
          </div>
        }
      </header>
      @for (row of data(); track row.id) {
        <ng-container
          [ngTemplateOutlet]="
            useDataTemplate() === 'values' ? values : valuesWithHistory
          "
          [ngTemplateOutletContext]="{
            $implicit: row,
            last: $last,
          }"
        ></ng-container>
      }

      @if (isExpanded()) {
        <div
          class="grid w-full grid-cols-[39%_20%_1fr_auto] items-center [&_span]:font-semibold"
        >
          @if (hasSum()) {
            <span> Summe </span>
            <span class="text-right"> {{ total() | currency }}</span>
            <div><!--placeholder--></div>
          }
          <button
            class="w-5"
            [class.justify-self-end]="hasSum()"
            maffiButton
            size="small"
            (click)="addRow.emit(); $event.stopPropagation()"
            animate.enter="animate-fade-in"
            animate.leave="animate-fade-out"
          >
            Hinzuf√ºgen
          </button>
        </div>
      }
    </section>
  }
</main>

<ng-template #values let-row let-last="last">
  <div
    class="grid grid-cols-[40%_20%_1fr_auto] items-center justify-center gap-2 border-b border-b-gray-500 text-sm"
    [class.border-b-0]="last"
  >
    @let isRowSelected = selectedRow() === row.id;

    <ng-container
      [ngTemplateOutlet]="categoryCell"
      [ngTemplateOutletContext]="{ isRowSelected, row }"
    />

    <ng-container #valueCell>
      @let isValueField = selectedField() === 'value';
      <app-number-input
        #valueInput
        class="hidden"
        [class.block!]="isRowSelected && isValueField"
        [formField]="form.value"
        (blurred)="submit()"
        (enterPress)="submit(); reset()"
      />
      <div
        class="hidden h-full items-center justify-end"
        [class.flex!]="!isRowSelected || (isRowSelected && !isValueField)"
        (click)="valueInput.select()"
      >
        <span class="h-full" (click)="editValue(row)">
          {{ row.value | currency }}
        </span>
      </div>
    </ng-container>

    <div #col3>
      <ng-template
        [ngTemplateOutlet]="col3Template()"
        [ngTemplateOutletContext]="{ $implicit: row }"
      />
      <!--placeholder-->
    </div>

    <button
      maffiButton
      class="mb-1 h-full"
      icon="Trash"
      size="mini"
      theme="secondary"
      (click)="deleteRow.emit(row.id)"
    ></button>
  </div>
</ng-template>

<ng-template #valuesWithHistory let-row let-last="last">
  <div
    class="grid grid-cols-[40%_20%_20%_auto] items-center justify-center gap-2 border-b border-b-gray-500 text-sm"
    [class.border-b-0]="last"
  >
    @let isRowSelected = selectedRow() === row.id;

    <ng-container
      [ngTemplateOutlet]="categoryCell"
      [ngTemplateOutletContext]="{ isRowSelected, row }"
    />

    <ng-container #forecastCell>
      @let isForecastField = selectedField() === 'forecast';
      @if (isRowSelected && isForecastField) {
        <app-number-input
          class="*:w-20"
          [formField]="form.forecast"
          (blurred)="submit(); selectedField.set(null)"
          (enterPress)="submit(); reset()"
        />
      } @else {
        <div class="flex items-center justify-end">
          <span class="h-full" (click)="editForecast(row)">
            {{ row.forecast | currency }}
          </span>
        </div>
      }
    </ng-container>

    <ng-container #valueCell>
      <div
        class="flex items-center justify-end"
        [class.text-green-500]="row.value <= row.forecast"
        [class.text-red-500]="row.value > row.forecast"
      >
        <span class="h-full" (click)="editValue(row)">
          {{ row.value | currency }}
        </span>
      </div>
    </ng-container>

    <button
      maffiButton
      class="mb-1 h-full"
      icon="Trash"
      size="mini"
      theme="secondary"
      (click)="deleteRow.emit(row.id)"
    ></button>
  </div>
</ng-template>

<ng-template #categoryCell let-isRowSelected="isRowSelected" let-row="row">
  @let isCategoryField = selectedField() === 'category';

  <app-string-input
    #categoryInput
    class="hidden"
    [class.block!]="isRowSelected && isCategoryField"
    [formField]="form.category"
    (blurred)="submit(); reset()"
    (enterPress)="submit(); reset()"
  />
  <div
    class="hidden h-full w-full items-center"
    [class.flex!]="!isRowSelected || (isRowSelected && !isCategoryField)"
    (click)="editCategory(row); categoryInput.select()"
  >
    <span class="h-full">
      {{ row.category }}
    </span>
  </div>
</ng-template>
